### THIS FILE IS AUTOMATICALLY GENERATED BY COB
### DO NOT EDIT THIS FILE DIRECTLY

{% for subsystem in project.subsystems %}
{% for line in subsystem.get_docker_preamble_steps() %}
{{line}}
{% endfor %}
{% endfor %}

FROM {{deployment_base_image}}

ENV PYTHON_VERSION={{python_version}} PYTHON_EXECUTABLE=python{{python_version}} LC_ALL=C.UTF-8 LANG=C.UTF-8 COB_IN_DOCKER=1

# nginx sources
RUN apt-get update
RUN apt-get -y install build-essential rsync software-properties-common libpq-dev nginx curl redis-server gcc libsasl2-dev libldap2-dev git sudo wget

RUN wget -O - http://nginx.org/keys/nginx_signing.key | sudo apt-key add -
RUN echo "deb http://nginx.org/packages/mainline/debian/ jessie nginx" | tee -a /etc/apt/sources.list
RUN echo "deb-src http://nginx.org/packages/mainline/debian/ jessie nginx" | tee -a /etc/apt/sources.list
RUN apt-get update
RUN apt-get install -y nginx

RUN $PYTHON_EXECUTABLE -m pip install -U virtualenv {{specific_vers}}

ADD . /app
RUN rm -rf /app/.cob

{% for subsystem in project.subsystems %}
{% for line in subsystem.get_docker_install_steps() %}
{{line}}
{% endfor %}
{% endfor %}

WORKDIR /app

ENV DOCKERIZE_VERSION v0.6.1
RUN curl -L https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz | tar xz -C /usr/local/bin

ENV COB_DOCKERIZED 1
{% if is_develop %}
ENV COB_DEVELOP_SDIST=/app/{{cob_sdist_filename}}
RUN $PYTHON_EXECUTABLE -m pip install $COB_DEVELOP_SDIST
{% else %}
RUN $PYTHON_EXECUTABLE -m pip install cob
{% endif %}

RUN {% if is_develop %}COB_DEVELOP=1{% endif %} cob -vvv bootstrap

## nginx configuration
RUN rm -rf /etc/nginx/conf.d/* /etc/nginx/sites-enabled/*

{{user_steps}}

EXPOSE 80 443
